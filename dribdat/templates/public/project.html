{% extends "layout.html" %}
{% import "macros/_misc.html" as misc %}

{% block page_title %}{{project.name}} - {{project.event.name}}{% endblock %}

{% block page_meta %}
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ url_for('project.project_view', project_id=project.id, _external=True) }}">
  <meta property="og:title" content="{{project.name}}">
  <meta property="og:image" content="{% if project.image_url %}{{project.image_url}}{% else %}{{ url_for('static', filename='img/badge-black.png', _external=True) }}{% endif %}">
  <meta property="og:description" content="{% if project.summary %}{{project.summary}}{% else %}{{ project.longtext|striptags|truncate(120) }}{% endif %}">
  <meta name="twitter:site" content="@opendatach">
  <meta name="twitter:card" content="summary">
  {% if project.user.cardtype == 'twitter' %}<meta name="twitter:creator" content="@{{ project.user.carddata }}">{% endif %}
  <meta name="description" content="{{project.summary}}">
  <meta name="author" content="{{project.user.username}}">
{% endblock %}

{% block css %}
<link href="{{ url_for('static', filename='css/rainbow/zenburnesque.css') }}" rel="stylesheet" type="text/css">
{% endblock %}
{% block js %}
<script type="text/javascript" src="{{ url_for('static', filename='css/rainbow/rainbow-custom.min.js') }}"></script>
{% endblock %}

{% block body_class %}project-home{% endblock %}

{% block content %}
<div class="btn-group project-edit-buttons" role="group" aria-label="Project tools">

  {% if allow_post and project.is_challenge %}
   <a id="project-post" href="{{ url_for('project.project_post', project_id=project.id) }}" title="Post an update to this project" class="btn btn-lg btn-success">
     <i class="fa fa-rocket" aria-hidden="true"></i>
     Post to Project</a>
  {% elif allow_post %}
   <a id="project-post" href="{{ url_for('project.project_post', project_id=project.id) }}" title="Post an update to this project" class="btn btn-lg btn-success">
     <i class="fa fa-clipboard" aria-hidden="true"></i>
     Post</a>
  {% endif %}
  {% if allow_edit %}
    {% if project.is_autoupdate %}
      <a href="{{ url_for('project.project_autoupdate', project_id=project.id) }}" title="Sync external data" class="btn btn-lg btn-warning">
        <i class="fa fa-refresh" aria-hidden="true"></i>
        Sync</a>
    {% endif %}
    <a href="{{ url_for('project.project_edit', project_id=project.id) }}" title="Edit project" class="btn btn-lg btn-warning">
      <i class="fa fa-pencil" aria-hidden="true"></i>
      Edit</a>
  {% endif %}

  {% if not project.event.lock_editing %}
    {% if project_starred %}
      <a href="{{ url_for('project.project_unstar_me', project_id=project.id) }}" class="project-star btn btn-lg btn-secondary"
        title="Click to stop being a member of the project"
        onclick="return confirm('Are you sure you wish to leave this team?')">
        <i class="fa fa-star"></i>
      </a>
    {% elif current_user and current_user.active %}
      <a href="{{ url_for('project.project_star', project_id=project.id) }}" class="btn btn-lg btn-primary project-star"
        title="Join this project">
       <i class="fa fa-star-o"></i>
       Join
      </a>
    {% else %}
      <a href="{{ url_for('auth.login') }}" class="btn btn-lg btn-primary project-star"
        title="Login to join this project">
       <i class="fa fa-star-o"></i>
       Join
      </a>
    {% endif %}
  {% endif %}

  {% if current_user.is_admin %}

    {% if project.event.lock_editing and project_starred %}
    <!-- Always allow admins to un-star -->
    <a href="{{ url_for('project.project_unstar_me', project_id=project.id) }}"  class="project-star btn btn-lg btn-secondary">
      <i class="fa fa-star"></i>
    </a>
    {% endif %}

  {% endif %}

</div><br clear="all">

{% if project.image_url %}
  <div class="project-image-container"
    style="background-image:url('{{project.image_url}}'); {% if project.logo_color %}background-color:{{project.logo_color}}; opacity:1.0{% endif %}"
    data-href="{{project.image_url}}"></div>
{% endif %}

<div class="jumbotron project-page phase-{{ project.phase }}" {% if project.logo_color %} style="border-color:{{project.logo_color}}"{% endif %}>

  <div class="project-score">
    <a href="{{ url_for('public.event_stages', event_id=project.event.id) }}" style="text-decoration:none">
      <span class="label label-info">{{ project.phase }}</span>
      <div class="progress" title="A score based on profile completeness and voting results">
        <div class="progress-bar" role="progressbar" aria-valuenow="{{project.score}}" aria-valuemin="0" aria-valuemax="70" style="width:{{project.score}}%">
          {{project.score}}
        </div>
      </div>
    </a>
  </div>

  <div class="project-name">
  {% if project.logo_icon %}
      <i class="fa fa-{{project.logo_icon}}"></i>
  {% endif %}
    <h2>{{project.name}}</h2>

  {% if project.category %}
    <div class="project-category">
      {% if project.category.logo_icon %}
        <i class="fa fa-{{project.category.logo_icon}}"></i>
      {% endif %}
      <a href="#category">{{ project.category.name }}</a>
    </div>
  {% endif %}

  {% if project.summary %}
    <p class="project-summary">
      {{project.summary}}
    </p>
  {% endif %}
  </div><!-- /.project-name -->

  <div class="badges">
    {% for s in project_dribs %}
      {% if s.icon and s.name == 'boost' %}
      <a class="boost" href="#" onclick="$('#dribs-tab-md').click(); return false" title="{{ s.title }}">
        <i class="fa fa-{{ s.icon }}" aria-hidden="true"></i>
      </a>
      {% endif %}
    {% endfor %}
  </div>

  {% if False and not project.is_challenge %}
  # TODO: latest log update
  <div class="latest-drib">
    {% for s in project_dribs[:1] %}
    <small>Top of the Log</small>
    <div class="timeline-content timeline-card js--fadeInBottom">
      {% if s.title %}
      <div class="timeline-img-header">
        <h2>{{s.title}}</h2>
      </div>
      {% endif %}

      {% if s.text %}
        <div class="content">
          {{s.text|markdown|safe}}
        </div>
      {% endif %}

      <div class="date">
      {% if s.ref_url %}
        <a href="{{ s.ref_url }}" target="_blank">
      {% endif %}
          {{s.date|format_datetime}}
          {% if s.author %} ~ <b>{{ s.author }}</b>{% endif %}
      {% if s.ref_url %}
        </a>
      {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if not project.is_challenge and project_starred and suggestions %}
    <div class="alert resource-list col-12">
      <a class="close" title="Close" href="#" data-dismiss="alert">&times;</a>
      <div class="profile-projects container-fluid">
        <div class="row flex-row flex-nowrap">
        {% for project in suggestions %}
          <a class="col-5 card project"
             href="{{ url_for('project.project_view', project_id=project.id) }}">

            {% if project.image_url %}
              <img class="project-image" src="{{project.image_url}}">
            {% endif %}

            <div class="card-body">
              <h5 class="card-title">{{ project.name }}</h5>
              <p class="card-text">{{ project.summary }}</p>
            </div>
          </a>
        {% endfor %}
        </div>
        <p class="category-tip mt-3 mb-0" style="margin-left:-1em">
          <span class="user-score" style="background:white">&#x1F4A1;</span>
            Suggestions for
            <a href="{{ url_for('public.event_stages', event_id=project.event.id) }}">
             this stage</a> of your project,
            visible only to you and your team members.
        </p>
      </div><!-- /profile-projects -->
    </div>
  {% endif %}

  {% if not project.is_challenge and not project.event.lock_resources %}
  <ul class="nav nav-pills nav-fill md-tabs" id="projectTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="project-tab-md" data-toggle="tab" href="#project-md" role="tab" aria-controls="project-md"
        aria-selected="true">Pitch</a>
    </li>
    {% if project.autotext %}
    <li class="nav-item">
      <a class="nav-link" id="readme-tab-md" data-toggle="tab" href="#readme-md" role="tab" aria-controls="readme-md"
        aria-selected="false">Readme</a>
    </li>
    {% endif %}
    {% if not project.is_challenge and not project.event.lock_resources %}
    <li class="nav-item">
      <a class="nav-link" id="dribs-tab-md" data-toggle="tab" href="#dribs-md" role="tab" aria-controls="dribs-md"
        aria-selected="false">Log</a>
    </li>
    {% endif %}
  </ul>
  {% endif %}

<div class="project-info tab-content" id="projectContent">

{% if not project.is_challenge %}
  <div class="tab-pane fade show active" id="project-md" role="tabpanel" aria-labelledby="project-tab-md">

    {% if current_user and current_user.active and not project.webpage_url and not project.longtext and not project.event.lock_editing %}
    <div class="alert alert-success" role="alert">
      <a class="close" title="Close" href="#" data-dismiss="alert">&times;</a>
      <!-- Helpful comment for new projects -->
      {% if not project_starred %}
        Join this project to <b>Post</b> on the Log, <b>Edit</b> the pitch or <b>Sync</b> any external content.
      {% else %}
        <b>Edit</b> the pitch to add content, or to <b>Embed</b> your presentation or demo here.
      {% endif %}
    </div>
    {% endif %}

{% endif %}

  {% if project.is_webembed and project.webpage_url %}
    <div class="project-webembed resizable">
      {{ project.webembed|safe }}
      <div class="win-size-grip"></div>
    </div>
    <a href="{{ project.webpage_url }}" class="btn btn-small btn-default" target="_blank">&#x26F6; Full screen</a>
  {% endif %}

  {% if project.longtext %}
    <div class="project-longtext">
      {{ project.longtext|onebox|markdown|safe }}
    </div>
  {% endif %}

{% if not project.is_challenge %}
  </div>
  <div class="tab-pane fade" id="readme-md" role="tabpanel" aria-labelledby="readme-tab-md">
{% endif %}

    {% if project.autotext %}
      {% if not project.is_challenge %}
      <div class="alert alert-secondary text-center">
        This content is a preview from an
        <a href="{{ project.autotext_url }}" target="_blank" title="Source link">
          external site</a>.
      </div>
      {% endif %}

    <div class="project-autotext"><div class="cover"></div>
      {{project.autotext|markdown}}
    </div>
    {% endif %}

{% if not project.is_challenge and not project.event.lock_resources %}
  </div>
  <div class="tab-pane fade" id="dribs-md" role="tabpanel" aria-labelledby="dribs-tab-md">

    {% if current_user and current_user.is_authenticated %}
    <center style="position:relative" class="mt-3">
      <a id="project-post" href="{{ url_for('project.project_post', project_id=project.id) }}" title="Post an update to this project" class="btn btn-success">
        <i class="fa fa-clipboard" aria-hidden="true"></i>
        Post an update</a>
    </center>
    {% endif %}

    <section class="timeline">
      {% for s in project_dribs %}
      <div class="timeline-item timeline-{{ s.name }}">
        <div class="timeline-img" title="{{ s.name }}">
          {% if s.icon %}
            <i class="fa fa-{{ s.icon }}" aria-hidden="true"></i>
          {% endif %}
        </div>
        <div class="timeline-content timeline-card js--fadeInBottom">
          {% if s.title %}
          <div class="timeline-img-header">
            <h2>{{s.title}}</h2>
          </div>
          {% endif %}

          {% if s.id and current_user.is_admin %}
            <a class="close" title="Delete post" href="{{ url_for('project.post_delete', project_id=project.id, activity_id=s.id) }}"
              onclick="if(!window.confirm('Delete this post?')) return false">&times;</a>
          {% endif %}

          {% if s.text %}
            <div class="content">
              {{s.text|markdown|safe}}
            </div>
          {% endif %}

          <div class="date">
          {% if s.ref_url %}
            <a href="{{ s.ref_url }}" target="_blank">
          {% endif %}
              {{s.date|format_datetime}}
              {% if s.author %} ~ <b>{{ s.author }}</b>{% endif %}
          {% if s.ref_url %}
            </a>
          {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}

    </section>

  </div><!-- /tab-pane -->
{% endif %}

</div><!-- /project-content -->

  {% if project.source_url and 'github.com' in project.source_url %}
    <div class="widget widget-github">
      <div data-theme="default" data-width="400" data-height="150" data-github="{{ project.source_url|replace('https://github.com/','') }}" class="github-card"></div>
      <script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>

      <div id="issues-list" data-github="{{ project.source_url|replace('https://github.com/','') }}" class="list-group list-data"><i>Loading ...</i></div>
    </div>
  {% endif %}

  <a name="team"></a>
  {% if project_team %}
    <div class="widget widget-team">
      <h5>Team</h5>
      {% for user in project_team %}
        {{ misc.render_user_profile(user) }}
        {% if current_user.is_admin %}
          <a href="{{ url_for('project.project_unstar', project_id=project.id, user_id=user.id) }}"
            title="Kick this user from team" onclick="if(!window.confirm('Kick {{ user.username }}?')) return false"
            >&times;</a>
        {% endif %}
      {% endfor %}
    </div>
  {% elif project.user and not project.event.lock_resources %}
    <div class="widget widget-team">
      {{ misc.render_user_profile(project.user) }}
      <p class="started-at">
        <small>
          Launched this at
          <a href="{{ url_for('public.event', event_id=project.event.id) }}">
            <b>{{ project.event.name }}</b>
          </a>
        </small>
      </p>
    </div>
  {% endif %}

  <div class="project-buttons" role="group" aria-label="Main navigation">
    {% if project.contact_url %}
      {% if project.contact_url.startswith('http') %}
        <a href="{{ project.contact_url }}" target="_blank" class="btn btn-lg" title="Contact the team"><span>&#x1f44b;</span> Contact</a>
      {% else %}
        <div class="btn btn-lg" title="Contact the team"><span>&#x1f44b;</span> {{ project.contact_url }}</div>
      {% endif %}
    {% endif %}
    {% if project.webpage_url %}
      <a href="{{ project.webpage_url }}" class="btn btn-lg" target="_blank" title="Project web link"><span>&#x1f310;</span> Explore</a>
    {% endif %}
    {% if project.download_url %}
      <a href="{{ project.download_url }}" target="_blank" class="btn btn-lg" title="Download link"><span>&#x1f4c2;</span> Download</a>
    {% endif %}
    {% if project.source_url %}
      <a href="{{ project.source_url }}" class="btn btn-lg" target="_blank" title="Source code"><span>&#x1f4bb;</span> Source</a>
    {% endif %}
  </div>

  {% if allow_edit %}
  <center><div class="btn-group">
    <a href="{{ url_for('project.project_details', project_id=project.id) }}" title="Edit project details" class="btn btn-lg btn-warning">
      <i class="fa fa-pencil" aria-hidden="true"></i>
      Details</a>
    {% if current_user.is_admin %}
    <a href="{{ url_for('admin.project_view', project_id=project.id) }}" title="Edit full details" class="btn btn-lg btn-secondary">
      <i class="fa fa-pencil" aria-hidden="true"></i>
      Admin</a>
    {% endif %}
    <a href="{{ url_for('project.project_boost', project_id=project.id) }}" class="btn btn-lg btn-info project-boost"
      title="Boost this project">
     <i class="fa fa-rocket"></i>
     Boost
    </a>
  </div></center>
  {% endif %}

  {% if current_user.is_admin %}
  <!-- Add arbitrary user to the team -->
  <center class="mb-3 mt-3">
    <form action="{{ url_for('project.project_star_user', project_id=project.id)}}" method="post">
      <i class="fa fa-child" aria-hidden="true"></i>
      <input type="text" name="username" placeholder="Enter username ..." />
      <input type="submit" value="+ Add" />
    </form>
  </center>
  {% endif %}

  {% if project.category %}
  <div class="panel panel-default category-details">
    <a name="category"></a>
    <div category-id="{{project.category.id}}" class="category-container" style="border-top:5px solid {{project.category.logo_color}}">
      <h3>{{ project.category.name }}</h3>
      {{ project.category.description|markdown }}
    </div>
  </div>
  {% endif %}

</div><!-- /.jumbotron .project-page -->

<div class="panel panel-default community-embed">
  <div class="panel-body"><i class="fa fa-comment"></i>
    {{project.event.community_embed|safe}}
  </div>
</div>

{% if not project.event.lock_resources %}
<center class="mt-5">
  <a class="btn btn-light btn-lg" href="{{ url_for('public.event', event_id=project.event.id) }}">
    <i class="fa fa-arrow-left" aria-hidden="true"></i>
    {{ project.event.name }}</a>
</center>
{% else %}
<center class="mt-5">
  <a class="btn btn-light btn-lg" href="javascript:history.back()">
    <i class="fa fa-arrow-left" aria-hidden="true"></i>
    Go back</a>
</center>
{% endif %}

{% endblock %}
